# 第 2 课：核心概念理解

**⏱ 预计时间**：45 分钟  
**🎯 学习目标**：理解项目架构、前后端通信和数据流  
**📚 难度**：⭐⭐ 基础进阶  
**📋 前置要求**：完成第 1 课

---

## 📖 课程概览

上一课我们成功运行了项目，这一课我们来了解它的"内部结构"。

就像了解一辆汽车，除了会开，还要知道它的引擎、刹车、油门是怎么工作的。

本课将讲解：

```
项目架构 → 前后端通信 → 数据存储 → 认证机制 → 盈亏计算
```

---

## 🏗 2.1 项目整体架构

### 全栈应用是什么？

Vibe Journal 是一个 **全栈 Web 应用**，由三个部分组成：

```
┌─────────────────────────────────────────────────────────────────────┐
│                          全栈应用结构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│    ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │
│    │   前端       │    │   后端       │    │      数据库          │  │
│    │  (Frontend)  │◀──▶│  (Backend)   │◀──▶│    (Database)       │  │
│    │             │    │             │    │                     │  │
│    │  Next.js    │    │   FastAPI   │    │      SQLite         │  │
│    │  端口:3000  │    │  端口:8000  │    │                     │  │
│    └─────────────┘    └─────────────┘    └─────────────────────┘  │
│                                                                     │
│         用户界面           业务逻辑            数据存储              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 用餐厅来类比

想象一个餐厅：

| 组件 | 类比 | 职责 |
|------|------|------|
| **前端** | 餐厅大堂 | 接待客人，展示菜单，接受点餐 |
| **后端** | 厨房 | 接收订单，处理食材，做菜 |
| **数据库** | 仓库 | 存储食材和配方 |

```
┌───────────────────────────────────────────────────────────────────┐
│                         餐厅类比图                                 │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│   👤 顾客                                                          │
│     │                                                             │
│     │ "我要一份红烧肉"                                             │
│     ▼                                                             │
│   ┌─────────────┐         ┌─────────────┐         ┌───────────┐  │
│   │   服务员     │  传达   │    厨房      │  取材   │    仓库    │  │
│   │  (前端)     │ ──────▶ │   (后端)    │ ──────▶ │  (数据库)  │  │
│   │             │         │             │         │           │  │
│   │ 展示菜单    │         │ 处理订单    │         │ 存储食材  │  │
│   │ 接受点餐    │         │ 烹饪菜品    │         │ 记录库存  │  │
│   └─────────────┘         └─────────────┘         └───────────┘  │
│         │                       │                                 │
│         │◀──────────────────────│                                 │
│         │      上菜                                               │
│         ▼                                                         │
│   👤 顾客享用美食                                                   │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 📁 2.2 项目目录结构

让我们看看项目的文件组织：

```
trading-journal/
│
├── 📂 backend/                 # 后端代码（Python）
│   ├── 📂 app/
│   │   ├── 📂 auth/           # 🔐 认证模块
│   │   │   ├── dependencies.py # 依赖注入（获取当前用户）
│   │   │   └── utils.py        # 工具函数（密码、JWT）
│   │   │
│   │   ├── 📂 crud/           # 📝 数据操作
│   │   │   ├── user.py         # 用户增删改查
│   │   │   ├── portfolio.py    # 投资组合增删改查
│   │   │   └── trade.py        # 交易记录增删改查
│   │   │
│   │   ├── 📂 models/         # 📊 数据模型
│   │   │   ├── user.py         # 用户表结构
│   │   │   ├── portfolio.py    # 投资组合表结构
│   │   │   └── trade.py        # 交易记录表结构
│   │   │
│   │   ├── 📂 routers/        # 🌐 API 路由
│   │   │   ├── auth.py         # 登录注册接口
│   │   │   ├── users.py        # 用户管理接口
│   │   │   ├── portfolios.py   # 投资组合接口
│   │   │   ├── trades.py       # 交易记录接口
│   │   │   └── analytics.py    # 数据分析接口
│   │   │
│   │   ├── 📂 schemas/        # 📋 数据验证
│   │   │   ├── user.py         # 用户数据格式
│   │   │   ├── portfolio.py    # 投资组合数据格式
│   │   │   └── trade.py        # 交易记录数据格式
│   │   │
│   │   ├── config.py          # ⚙️ 配置文件
│   │   ├── database.py        # 🗄️ 数据库连接
│   │   └── main.py            # 🚀 应用入口
│   │
│   ├── requirements.txt       # 📦 Python 依赖
│   └── run.py                 # ▶️ 启动脚本
│
├── 📂 frontend/               # 前端代码（TypeScript）
│   ├── 📂 app/               # 📱 页面
│   │   ├── dashboard/        # 仪表板页面
│   │   ├── login/            # 登录页面
│   │   └── register/         # 注册页面
│   │
│   ├── 📂 components/        # 🧩 组件
│   │   ├── ui/               # 通用 UI 组件
│   │   └── dashboard-nav.tsx # 导航栏
│   │
│   ├── 📂 lib/               # 🛠️ 工具库
│   │   ├── api.ts            # API 调用封装
│   │   ├── store.ts          # 状态管理
│   │   └── utils.ts          # 工具函数
│   │
│   └── package.json          # 📦 Node 依赖
│
└── docker-compose.yml        # 🐳 Docker 配置
```

### 代码是如何组织的？

```
┌─────────────────────────────────────────────────────────────────────┐
│                      后端分层架构                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   HTTP 请求进入                                                      │
│        │                                                            │
│        ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                     路由层 (Routers)                         │  │
│   │   接收请求，调用业务逻辑，返回响应                               │  │
│   │   例：POST /api/trades → 调用 create_trade()                 │  │
│   └─────────────────────────────────────────────────────────────┘  │
│        │                                                            │
│        ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                   数据验证层 (Schemas)                        │  │
│   │   验证输入数据的格式和类型                                      │  │
│   │   例：检查 entry_price 是否为数字                              │  │
│   └─────────────────────────────────────────────────────────────┘  │
│        │                                                            │
│        ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    CRUD 层 (CRUD)                            │  │
│   │   实际的数据库操作                                              │  │
│   │   例：INSERT INTO trades VALUES (...)                        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│        │                                                            │
│        ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                   数据模型层 (Models)                         │  │
│   │   定义数据库表结构                                              │  │
│   │   例：trades 表有 symbol, entry_price, quantity 等字段        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│        │                                                            │
│        ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    数据库 (SQLite)                           │  │
│   │   持久化存储数据                                               │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 2.3 前后端通信

### API 是什么？

**API (Application Programming Interface)** 就像餐厅的菜单：

- 菜单告诉你可以点什么菜
- API 告诉你可以调用什么功能

### REST API 风格

我们的后端使用 **REST API** 风格：

| HTTP 方法 | 用途 | 示例 |
|-----------|------|------|
| **GET** | 获取数据 | 获取交易列表 |
| **POST** | 创建数据 | 创建新交易 |
| **PATCH** | 更新数据 | 更新交易信息 |
| **DELETE** | 删除数据 | 删除交易 |

### 完整的 API 列表

```
┌─────────────────────────────────────────────────────────────────────┐
│                          API 端点列表                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  🔐 认证相关                                                         │
│  ├── POST   /api/auth/register    注册新用户                        │
│  ├── POST   /api/auth/login       用户登录                          │
│  └── GET    /api/auth/me          获取当前用户信息                   │
│                                                                     │
│  👥 用户管理（仅管理员）                                              │
│  ├── GET    /api/users            获取所有用户                       │
│  ├── GET    /api/users/{id}       获取指定用户                       │
│  ├── PATCH  /api/users/{id}       更新用户信息                       │
│  └── DELETE /api/users/{id}       删除用户                          │
│                                                                     │
│  📁 投资组合                                                         │
│  ├── GET    /api/portfolios       获取我的所有组合                   │
│  ├── POST   /api/portfolios       创建新组合                        │
│  ├── GET    /api/portfolios/{id}  获取指定组合                       │
│  ├── PATCH  /api/portfolios/{id}  更新组合                          │
│  └── DELETE /api/portfolios/{id}  删除组合                          │
│                                                                     │
│  📝 交易记录                                                         │
│  ├── GET    /api/trades/portfolio/{id}  获取组合的交易              │
│  ├── POST   /api/trades                 创建交易                    │
│  ├── GET    /api/trades/{id}            获取交易详情                │
│  ├── PATCH  /api/trades/{id}            更新交易                    │
│  ├── POST   /api/trades/{id}/close      平仓交易                    │
│  ├── POST   /api/trades/{id}/screenshot 上传截图                    │
│  └── DELETE /api/trades/{id}            删除交易                    │
│                                                                     │
│  📊 数据分析                                                         │
│  ├── GET    /api/analytics/portfolio/{id}           综合分析        │
│  └── GET    /api/analytics/portfolio/{id}/by-symbol 按股票分析      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 一次请求的完整流程

以"创建交易"为例：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    创建交易的完整流程                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1️⃣ 用户在前端填写表单                                               │
│                                                                     │
│     ┌─────────────────────────────────────────┐                     │
│     │ 股票代码: RELIANCE                       │                     │
│     │ 类型: 做多                               │                     │
│     │ 入场价: 2500                             │                     │
│     │ 数量: 10                                 │                     │
│     └─────────────────────────────────────────┘                     │
│           │                                                         │
│           │ 点击"创建"                                              │
│           ▼                                                         │
│  2️⃣ 前端发送 HTTP 请求                                               │
│                                                                     │
│     POST http://localhost:8000/api/trades                           │
│     Headers:                                                        │
│       Authorization: Bearer eyJhbGciOiJIUzI1NiIs...（JWT令牌）      │
│       X-CSRF-Token: abc123...（CSRF令牌）                           │
│     Body:                                                           │
│       {                                                             │
│         "portfolio_id": 1,                                          │
│         "symbol": "RELIANCE",                                       │
│         "trade_type": "long",                                       │
│         "entry_price": 2500,                                        │
│         "quantity": 10,                                             │
│         "entry_date": "2024-01-15T10:30:00"                        │
│       }                                                             │
│           │                                                         │
│           ▼                                                         │
│  3️⃣ 后端处理请求                                                     │
│                                                                     │
│     a. 验证 JWT 令牌 → 获取用户身份                                  │
│     b. 验证 CSRF 令牌 → 防止跨站攻击                                 │
│     c. 验证数据格式 → 检查字段是否正确                               │
│     d. 检查权限 → 用户是否拥有该投资组合                             │
│     e. 插入数据库 → 创建交易记录                                     │
│           │                                                         │
│           ▼                                                         │
│  4️⃣ 后端返回响应                                                     │
│                                                                     │
│     HTTP 201 Created                                                │
│     {                                                               │
│       "id": 1,                                                      │
│       "symbol": "RELIANCE",                                         │
│       "status": "open",                                             │
│       "entry_price": 2500,                                          │
│       ...                                                           │
│     }                                                               │
│           │                                                         │
│           ▼                                                         │
│  5️⃣ 前端更新界面                                                     │
│                                                                     │
│     显示新创建的交易记录                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🗄️ 2.4 数据存储

### 数据库结构

我们使用 **SQLite** 数据库，包含三张表：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        数据库关系图                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐                                                │
│  │     users       │                                                │
│  ├─────────────────┤                                                │
│  │ id (主键)       │                                                │
│  │ email           │                                                │
│  │ username        │                                                │
│  │ hashed_password │                                                │
│  │ is_admin        │                                                │
│  │ is_active       │                                                │
│  └────────┬────────┘                                                │
│           │                                                         │
│           │ 一个用户可以有多个投资组合 (1:N)                          │
│           ▼                                                         │
│  ┌─────────────────┐                                                │
│  │   portfolios    │                                                │
│  ├─────────────────┤                                                │
│  │ id (主键)       │                                                │
│  │ user_id (外键)  │──── 关联到 users.id                            │
│  │ name            │                                                │
│  │ description     │                                                │
│  │ initial_balance │                                                │
│  └────────┬────────┘                                                │
│           │                                                         │
│           │ 一个投资组合可以有多笔交易 (1:N)                          │
│           ▼                                                         │
│  ┌─────────────────┐                                                │
│  │     trades      │                                                │
│  ├─────────────────┤                                                │
│  │ id (主键)       │                                                │
│  │ portfolio_id    │──── 关联到 portfolios.id                       │
│  │ symbol          │                                                │
│  │ trade_type      │ (long/short)                                   │
│  │ status          │ (open/closed)                                  │
│  │ entry_price     │                                                │
│  │ entry_date      │                                                │
│  │ quantity        │                                                │
│  │ exit_price      │                                                │
│  │ exit_date       │                                                │
│  │ profit_loss     │ (自动计算)                                      │
│  │ notes           │                                                │
│  │ tags            │                                                │
│  └─────────────────┘                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 关系说明

```
用户（User）
    │
    └── 拥有多个 ──▶ 投资组合（Portfolio）
                        │
                        └── 包含多笔 ──▶ 交易（Trade）
```

**示例数据**：

```
用户: trader001
├── 投资组合: 日内交易
│   ├── 交易: RELIANCE 做多 +₹1,000
│   ├── 交易: TCS 做空 -₹500
│   └── 交易: INFY 做多 (持仓中)
│
└── 投资组合: 长线投资
    └── 交易: HDFCBANK 做多 (持仓中)
```

---

## 🔐 2.5 认证与安全

### JWT 认证流程

**JWT (JSON Web Token)** 是一种安全的身份验证方式：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        JWT 认证流程                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1️⃣ 登录                                                            │
│                                                                     │
│     用户 ────────▶ 后端                                             │
│          提交用户名/密码                                             │
│                                                                     │
│     后端:                                                           │
│     ├── 查询数据库验证用户                                           │
│     ├── 验证密码 (bcrypt)                                           │
│     └── 生成 JWT 令牌                                               │
│                                                                     │
│     用户 ◀──────── 后端                                             │
│          返回 JWT 令牌                                               │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  2️⃣ 后续请求                                                        │
│                                                                     │
│     用户 ────────▶ 后端                                             │
│          请求头携带: Authorization: Bearer <JWT令牌>                │
│                                                                     │
│     后端:                                                           │
│     ├── 解析 JWT 令牌                                               │
│     ├── 验证签名和有效期                                             │
│     └── 获取用户身份                                                │
│                                                                     │
│     用户 ◀──────── 后端                                             │
│          返回请求的数据                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### JWT 令牌结构

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzA...
    │                                      │                    │
    └── Header（头部）                      └── Payload（载荷）   └── Signature（签名）
        算法信息                                用户ID、过期时间        验证签名
```

### CSRF 保护

**CSRF (Cross-Site Request Forgery)** 是一种攻击方式，我们使用 **Double Submit Cookie** 模式防护：

```
┌─────────────────────────────────────────────────────────────────────┐
│                       CSRF 保护机制                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  登录成功后：                                                        │
│  ├── 服务器设置 CSRF 令牌到 Cookie                                   │
│  └── 同时在响应头返回 X-CSRF-Token                                   │
│                                                                     │
│  后续 POST/PUT/DELETE 请求：                                        │
│  ├── 浏览器自动发送 Cookie 中的令牌                                  │
│  └── 前端代码在请求头添加 X-CSRF-Token                               │
│                                                                     │
│  服务器验证：                                                        │
│  └── Cookie 中的令牌 === 请求头中的令牌 ? 通过 : 拒绝               │
│                                                                     │
│  为什么有效？                                                        │
│  └── 攻击者无法读取 Cookie 值，无法伪造请求头                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 💰 2.6 盈亏计算逻辑

### 做多 vs 做空

| 类型 | 操作 | 盈利条件 |
|------|------|----------|
| **做多 (Long)** | 先买后卖 | 价格上涨 |
| **做空 (Short)** | 先卖后买 | 价格下跌 |

### 盈亏计算公式

```
┌─────────────────────────────────────────────────────────────────────┐
│                        盈亏计算公式                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  做多 (Long):                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  盈亏 = (出场价格 - 入场价格) × 数量                          │   │
│  │                                                              │   │
│  │  例：买入 RELIANCE                                           │   │
│  │      入场价: ₹2,500                                          │   │
│  │      出场价: ₹2,600                                          │   │
│  │      数量: 10 股                                              │   │
│  │                                                              │   │
│  │      盈亏 = (2600 - 2500) × 10 = ₹1,000 ✅ 盈利              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  做空 (Short):                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  盈亏 = (入场价格 - 出场价格) × 数量                          │   │
│  │                                                              │   │
│  │  例：做空 TCS                                                 │   │
│  │      入场价: ₹3,500                                          │   │
│  │      出场价: ₹3,400                                          │   │
│  │      数量: 5 股                                               │   │
│  │                                                              │   │
│  │      盈亏 = (3500 - 3400) × 5 = ₹500 ✅ 盈利                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  盈亏百分比:                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  盈亏% = (盈亏金额 / 入场成本) × 100%                         │   │
│  │                                                              │   │
│  │  入场成本 = 入场价格 × 数量                                   │   │
│  │                                                              │   │
│  │  例：上面做多的例子                                           │   │
│  │      入场成本 = 2500 × 10 = ₹25,000                          │   │
│  │      盈亏% = (1000 / 25000) × 100% = 4%                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 代码实现

```python
def calculate_profit_loss(trade):
    """计算交易的盈亏金额和百分比"""
    
    if trade.exit_price is None:
        return 0.0, 0.0  # 未平仓，无盈亏
    
    # 根据交易类型计算
    if trade.trade_type == "long":
        # 做多：价格上涨盈利
        pl = (trade.exit_price - trade.entry_price) * trade.quantity
    else:
        # 做空：价格下跌盈利
        pl = (trade.entry_price - trade.exit_price) * trade.quantity
    
    # 计算百分比
    cost = trade.entry_price * trade.quantity
    pl_percentage = (pl / cost) * 100
    
    return pl, pl_percentage
```

---

## 📊 2.7 分析指标说明

Analytics 页面展示的各项指标含义：

| 指标 | 英文 | 含义 | 计算方法 |
|------|------|------|----------|
| **总盈亏** | Total P&L | 所有已平仓交易的总盈亏 | 累加所有盈亏 |
| **胜率** | Win Rate | 盈利交易的比例 | 盈利次数 ÷ 总交易数 × 100% |
| **平均盈亏** | Avg P&L | 每笔交易的平均盈亏 | 总盈亏 ÷ 交易数 |
| **平均盈利** | Avg Win | 盈利交易的平均盈利 | 总盈利 ÷ 盈利次数 |
| **平均亏损** | Avg Loss | 亏损交易的平均亏损 | 总亏损 ÷ 亏损次数 |
| **盈利因子** | Profit Factor | 总盈利与总亏损的比值 | 总盈利 ÷ |总亏损| |

### 盈利因子的意义

```
盈利因子 > 1   →  总体盈利  ✅
盈利因子 = 1   →  不赚不亏  ⚖️
盈利因子 < 1   →  总体亏损  ❌

例如：
  盈利因子 = 2.0  →  每亏 1 元，能赚 2 元
  盈利因子 = 0.5  →  每赚 1 元，会亏 2 元
```

---

## 💡 实践任务

### 任务 1：探索 API 文档

1. 打开 http://localhost:8000/docs
2. 尝试以下操作：
   - [ ] 找到 "auth" 分组下的接口
   - [ ] 点击 "Try it out" 测试登录接口
   - [ ] 查看返回的 JWT 令牌

### 任务 2：查看数据库

1. 下载 [DB Browser for SQLite](https://sqlitebrowser.org/)
2. 打开 `backend/trade_journal.db`
3. 查看三张表的数据

### 任务 3：理解请求流程

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 在应用中创建一笔交易
4. 观察 HTTP 请求的内容

---

## 📚 知识检查

1. **全栈应用由哪三部分组成？**

2. **REST API 中，GET、POST、PATCH、DELETE 分别用于什么？**

3. **JWT 令牌用于什么目的？**

4. **做多和做空的盈亏计算有什么区别？**

5. **盈利因子为 1.5 意味着什么？**

<details>
<summary>点击查看答案</summary>

1. 前端（用户界面）、后端（业务逻辑）、数据库（数据存储）
2. GET 获取数据、POST 创建数据、PATCH 更新数据、DELETE 删除数据
3. 身份验证，证明"我是谁"
4. 做多：(出场价-入场价)×数量；做空：(入场价-出场价)×数量
5. 每亏损 1 元，能盈利 1.5 元，整体盈利

</details>

---

## 📌 核心要点总结

1. **全栈应用 = 前端 + 后端 + 数据库**
2. **前后端通过 REST API（HTTP 请求）通信**
3. **数据存储在 SQLite 数据库中，有三张表**
4. **JWT 用于身份验证，CSRF 用于防止攻击**
5. **做多看涨，做空看跌，盈亏计算要注意方向**

---

## ➡️ 下一课预告

**第 3 课：实战操作指南**

在下一课中，我们将学习：

- 如何规划和管理投资组合
- 交易记录的最佳实践
- 利用分析功能优化交易
- 截图和笔记的使用技巧

---

> 📖 **下一步**：[第 3 课：实战操作指南](./03-实战操作.md)
